openapi: 3.0.3
info:
  title: Conversations API
  version: 1.0.0
  description: Endpoints del módulo de conversaciones (listado con filtros y paginación)
servers:
  - url: /channels
paths:
  /conversations:
    get:
      summary: Listar conversaciones
      description: >-
        Retorna una lista de conversaciones con metadatos del participante y el último mensaje.
        Protegido por `authenticate` y `authorize('/conversations','read')`.
      tags: [Conversations]
      parameters:
        - in: query
          name: status
          schema: { type: string }
          description: Estado de la conversación (p. ej. open, closed)
        - in: query
          name: channel_id
          schema: { type: string, format: uuid }
          description: ID del canal
        - in: query
          name: assigned_agent_id
          schema: { type: integer, minimum: 1 }
          description: ID del agente asignado
        - in: query
          name: participant_id
          schema: { type: string }
          description: Identificador del participante en el canal (teléfono, userId, etc.)
        - in: query
          name: participant_type
          schema:
            type: string
            enum: [agent, lead, client, prospect, customer, system]
          description: Tipo de participante
        - in: query
          name: date_from
          schema: { type: string, format: date-time }
          description: Filtrar por fecha de creación (>=)
        - in: query
          name: date_to
          schema: { type: string, format: date-time }
          description: Filtrar por fecha de creación (<=)
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 100 }
          description: Límite de resultados (máx 100)
        - in: query
          name: offset
          schema: { type: integer, minimum: 0 }
          description: Desplazamiento para paginación
        - in: query
          name: sortBy
          schema:
            type: string
            enum: [created_at, updated_at, last_message_at]
          description: Campo de ordenamiento
        - in: query
          name: sortDir
          schema:
            type: string
            enum: [asc, desc]
          description: Dirección de ordenamiento
      responses:
        '200':
          description: Listado de conversaciones
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResponseConversationList'
              examples:
                success:
                  value:
                    successful: true
                    message: Conversations retrieved successfully
                    statusCode: 200
                    data:
                      - id: "conv_a1b2c3d4"
                        status: open
                        company_id: 101
                        channel_id: "chan_whatsapp_456"
                        external_id: "wa_ext_7890"
                        updated_at: "2025-10-30T10:00:00Z"
                        created_at: "2025-10-29T15:30:00Z"
                        participant:
                          id: "+573001234567"
                          name: "Juan Pérez"
                          avatar: "https://.../avatar.png"
                          type: customer
                          meta:
                            phone: "+573001234567"
                        last_message:
                          id: "msg_f5g4h3i2"
                          message: "¿Cómo puedo ayudarte con tu pedido?"
                          created_at: "2025-10-30T10:00:00Z"
                        assigned_agent:
                          id: "42"
                          name: ""
                          avatar: ""
        '400':
          description: Parámetros inválidos
        '401':
          description: No autenticado
        '403':
          description: No autorizado
        '500':
          description: Error interno
  /conversations/{id}:
    delete:
      summary: Eliminar conversación
      description: Elimina una conversación por ID. Requiere permisos de delete.
      tags: [Conversations]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
          description: ID de la conversación a eliminar
      responses:
        '200':
          description: Conversación eliminada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResponseDeleteResult'
              examples:
                success:
                  value:
                    successful: true
                    message: Conversation deleted successfully
                    statusCode: 200
                    data: true
        '400': { description: Parámetros inválidos }
        '401': { description: No autenticado }
        '403': { description: No autorizado }
        '404': { description: Conversación no encontrada }
        '500': { description: Error interno }
  /messages:
    post:
      summary: Enviar/crear mensaje
      description: Crea un nuevo mensaje asociado a una conversación.
      tags: [Messages]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateMessageRequest'
            examples:
              create:
                value:
                  from: "+573001234567"
                  to: "+573009998888"
                  message: "Hola, ¿en qué puedo ayudarte?"
                  metadata: { source: "inbox" }
                  direction: "outgoing"
                  conversation_id: "11111111-2222-3333-4444-555555555555"
                  content_type: "text"
      responses:
        '201':
          description: Mensaje creado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResponseMessage'
        '400': { description: Datos inválidos }
        '401': { description: No autenticado }
        '403': { description: No autorizado }
        '404': { description: Conversación no encontrada }
        '500': { description: Error interno }
  /messages/{conversation_id}:
    get:
      summary: Listar mensajes por conversación
      description: Retorna mensajes de una conversación con filtros y paginación.
      tags: [Messages]
      parameters:
        - in: path
          name: conversation_id
          required: true
          schema: { type: string, format: uuid }
          description: ID de la conversación
        - in: query
          name: direction
          schema: { type: string, enum: [incoming, outgoing] }
        - in: query
          name: status
          schema: { type: string, enum: [PENDING, SENT, DELIVERED, READ, FAILED, RECEIVED] }
        - in: query
          name: content_type
          schema: { type: string }
        - in: query
          name: from
          schema: { type: string }
        - in: query
          name: to
          schema: { type: string }
        - in: query
          name: date_from
          schema: { type: string, format: date-time }
        - in: query
          name: date_to
          schema: { type: string, format: date-time }
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 100 }
        - in: query
          name: offset
          schema: { type: integer, minimum: 0 }
        - in: query
          name: sortBy
          schema: { type: string, enum: [timestamp, created_at] }
        - in: query
          name: sortDir
          schema: { type: string, enum: [asc, desc] }
      responses:
        '200':
          description: Listado de mensajes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResponseMessageList'
        '400': { description: Parámetros inválidos }
        '401': { description: No autenticado }
        '403': { description: No autorizado }
        '404': { description: Conversación no encontrada }
        '500': { description: Error interno }
  /messages/{id}:
    get:
      summary: Obtener mensaje por ID
      tags: [Messages]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: Mensaje encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResponseMessage'
        '400': { description: Parámetros inválidos }
        '401': { description: No autenticado }
        '403': { description: No autorizado }
        '404': { description: Mensaje no encontrado }
        '500': { description: Error interno }
  /messages/{id}/status:
    put:
      summary: Actualizar estado del mensaje
      tags: [Messages]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateMessageStatusRequest'
            examples:
              update:
                value: { status: "READ" }
      responses:
        '200':
          description: Estado actualizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResponseMessage'
        '400': { description: Datos inválidos }
        '401': { description: No autenticado }
        '403': { description: No autorizado }
        '404': { description: Mensaje no encontrado }
        '500': { description: Error interno }
    post:
      summary: Crear conversación
      description: >-
        Crea una conversación para un canal y `external_id` dados. Retorna 409 si ya existe
        una conversación con el mismo `external_id` para el `channel_id`.
        Protegido por `authenticate` y `authorize('/conversations','create')`.
      tags: [Conversations]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateConversationRequest'
            examples:
              create:
                value:
                  company_id: 101
                  assigned_agent_id: 42
                  external_id: "wa_ext_7890"
                  participant_type: customer
                  participant_id: "+573001234567"
                  channel_id: "11111111-2222-3333-4444-555555555555"
                  participant_meta:
                    name: "Juan Pérez"
                    phone: "+573001234567"
                    avatar: "https://res.cloudinary.com/dpfnxj52w/image/upload/v1761856211/0d6e5e4c-d792-4447-b0ca-f42c2a9aca73.png"
      responses:
        '201':
          description: Conversación creada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResponseConversationCreated'
        '400':
          description: Datos inválidos
        '401':
          description: No autenticado
        '403':
          description: No autorizado
        '404':
          description: Company no encontrada
        '409':
          description: Ya existe una conversación con el external_id para el canal
        '500':
          description: Error interno

components:
  schemas:
    CreateConversationRequest:
      type: object
      required: [company_id, channel_id, external_id, participant_type]
      properties:
        company_id:
          type: integer
          minimum: 1
        channel_id:
          type: string
          format: uuid
        external_id:
          type: string
          minLength: 1
        participant_id:
          type: string
        participant_meta:
          type: object
          additionalProperties: true
        participant_type:
          type: string
          enum: [agent, lead, client, prospect, customer, system]
        assigned_agent_id:
          type: integer
          minimum: 1

    ResponseConversationList:
      type: object
      properties:
        successful:
          type: boolean
        message:
          type: string
        statusCode:
          type: integer
        data:
          type: array
          items:
            $ref: '#/components/schemas/ConversationItem'

    ConversationItem:
    ResponseConversationCreated:
      type: object
      properties:
        successful:
          type: boolean
        message:
          type: string
          example: Conversation created successfully
        statusCode:
          type: integer
          example: 201
        data:
          $ref: '#/components/schemas/ConversationEntity'

    ConversationEntity:
      type: object
      required: [id, status, company_id, channel_id, external_id, created_at, updated_at, participant_type]
      properties:
        id:
          type: string
          format: uuid
        status:
          type: string
        company_id:
          type: integer
        channel_id:
          type: string
          format: uuid
        external_id:
          type: string
        assigned_agent_id:
          type: integer
          nullable: true
        participant_id:
          type: string
          nullable: true
        participant_meta:
          type: object
          additionalProperties: true
          nullable: true
        participant_type:
          type: string
          enum: [agent, lead, client, prospect, customer, system]
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        last_message_at:
          type: string
          format: date-time
          nullable: true
      type: object
      required: [id, status, company_id, channel_id, external_id, updated_at, created_at, participant, last_message]
      properties:
        id:
          type: string
          format: uuid
        status:
          type: string
        company_id:
          type: integer
        channel_id:
          type: string
          format: uuid
        external_id:
          type: string
        updated_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        participant:
          $ref: '#/components/schemas/Participant'
        last_message:
          $ref: '#/components/schemas/MessageSummary'

    Participant:
      type: object
      required: [id, type]
      properties:
        id:
          type: string
        name:
          type: string
        avatar:
          type: string
          format: uri
        type:
          type: string
          enum: [agent, lead, client, prospect, customer, system]
        meta:
          type: object
          additionalProperties: true

    MessageSummary:
      type: object
      required: [id, message, created_at]
      properties:
        id:
          type: string
        message:
          type: string
        created_at:
          type: string
          format: date-time

    AssignedAgent:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        avatar:
          type: string
          format: uri

    ResponseDeleteResult:
      type: object
      properties:
        successful: { type: boolean }
        message: { type: string }
        statusCode: { type: integer }
        data: { type: boolean }

    CreateMessageRequest:
      type: object
      required: [message, direction, conversation_id, content_type]
      properties:
        from: { type: string }
        to: { type: string }
        message: { type: string }
        payload: { type: object, additionalProperties: true }
        metadata: { type: object, additionalProperties: true }
        direction: { type: string, enum: [incoming, outgoing] }
        conversation_id: { type: string, format: uuid }
        content_type: { type: string }

    UpdateMessageStatusRequest:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [PENDING, SENT, DELIVERED, READ, FAILED, RECEIVED]

    MessageEntity:
      type: object
      required: [id, message, direction, timestamp, conversation_id, status, content_type, created_at, updated_at]
      properties:
        id: { type: string, format: uuid }
        from: { type: string }
        to: { type: string }
        message: { type: string }
        payload: { type: object, additionalProperties: true }
        metadata: { type: object, additionalProperties: true }
        direction: { type: string, enum: [incoming, outgoing] }
        timestamp: { type: string, format: date-time }
        conversation_id: { type: string, format: uuid }
        status: { type: string, enum: [PENDING, SENT, DELIVERED, READ, FAILED, RECEIVED] }
        content_type: { type: string }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }

    ResponseMessage:
      type: object
      properties:
        successful: { type: boolean }
        message: { type: string }
        statusCode: { type: integer }
        data:
          $ref: '#/components/schemas/MessageEntity'

    ResponseMessageList:
      type: object
      properties:
        successful: { type: boolean }
        message: { type: string }
        statusCode: { type: integer }
        data:
          type: array
          items:
            $ref: '#/components/schemas/MessageEntity'
